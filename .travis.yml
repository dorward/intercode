sudo: false
branches:
  only:
  - master
language: minimal
before_install:
# TODO figure out if it's possible to get buildkit running on Travis, for faster builds
# - curl -O http://launchpadlibrarian.net/340284182/libseccomp2_2.3.1-2.1ubuntu3_amd64.deb
# - sudo dpkg -i libseccomp2_2.3.1-2.1ubuntu3_amd64.deb
# - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
# - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) test"
# - sudo apt-get update
# - sudo apt-get install -y dpkg
# - sudo apt-get -y remove docker-ce
# - sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
# - sudo cat /var/log/upstart/docker.log
- sudo rm /usr/local/bin/docker-compose
- curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname
  -s`-`uname -m` > docker-compose
- chmod +x docker-compose
- sudo mv docker-compose /usr/local/bin
before_script:
- echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
script:
- docker pull neinteractiveliterature/intercode:test-$TRAVIS_COMMIT
- docker-compose -f docker-compose.test.yml -f docker-compose.${DATABASE,,}.yml run
  -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
  -e LANGUAGE=$LANGUAGE -e DATABASE=$DATABASE
  -e CI=$CI -e TRAVIS=$TRAVIS -e TRAVIS_COMMIT=$TRAVIS_COMMIT
  -e TRAVIS_BRANCH=$TRAVIS_BRANCH -e TRAVIS_PULL_REQUEST_BRANCH=$TRAVIS_PULL_REQUEST_BRANCH
  -e TRAVIS_PULL_REQUEST_SHA=$TRAVIS_PULL_REQUEST_SHA
  -e TRAVIS_JOB_ID=$TRAVIS_JOB_ID -e TRAVIS_JOB_NUMBER=$TRAVIS_JOB_NUMBER -e TRAVIS_BUILD_NUMBER=$TRAVIS_BUILD_NUMBER
  -e GIT_COMMITTED_AT=$(git log -1 --pretty=format:%ct)
  web
  test/travis-complete.sh
stages:
- build
- test
- coverage processing
- docker push
jobs:
  include:
  - stage: build
    before_script:
    - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin
    - test/docker-pull.sh
    script:
    - docker build
      --target build
      -f Dockerfile.web
      --cache-from neinteractiveliterature/intercode:build-latest
      --cache-from neinteractiveliterature/intercode:build-${TRAVIS_PULL_REQUEST_BRANCH}
      -t neinteractiveliterature/intercode:build-${TRAVIS_PULL_REQUEST_BRANCH:-latest} .
    - docker push neinteractiveliterature/intercode:build-${TRAVIS_PULL_REQUEST_BRANCH:-latest}
    - docker tag neinteractiveliterature/intercode:build-${TRAVIS_PULL_REQUEST_BRANCH:-latest} neinteractiveliterature/intercode:build-${TRAVIS_COMMIT}
    - docker push neinteractiveliterature/intercode:build-${TRAVIS_COMMIT}
    - docker pull neinteractiveliterature/intercode:test-${TRAVIS_PULL_REQUEST_BRANCH:-latest} || true
    - docker build
      -f Dockerfile.web
      --target test
      --build-arg INTERCODE_TAG=${TRAVIS_COMMIT}
      --cache-from neinteractiveliterature/intercode:build-${TRAVIS_PULL_REQUEST_BRANCH:-latest}
      --cache-from neinteractiveliterature/intercode:test-${TRAVIS_PULL_REQUEST_BRANCH:-latest}
      --cache-from neinteractiveliterature/intercode:build-${TRAVIS_COMMIT}
      -t neinteractiveliterature/intercode:test-${TRAVIS_COMMIT}
      .
    - docker push neinteractiveliterature/intercode:test-$TRAVIS_COMMIT
    - docker tag neinteractiveliterature/intercode:test-$TRAVIS_COMMIT neinteractiveliterature/intercode:test-${TRAVIS_PULL_REQUEST_BRANCH:-latest}
    - docker push neinteractiveliterature/intercode:test-${TRAVIS_PULL_REQUEST_BRANCH:-latest}
  - stage: coverage processing
    language: generic
    before_script:
    - pip install --user awscli
    - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64
      > ./cc-test-reporter
    - chmod +x ./cc-test-reporter
    script:
    - aws s3 sync "s3://intercode2-coverage/coverage/$TRAVIS_BUILD_NUMBER" coverage/
    - "./cc-test-reporter sum-coverage --output - --parts 4 coverage/codeclimate.*.json
      | ./cc-test-reporter upload-coverage --input -"
  - stage: docker push
    language: minimal
    script:
    - docker pull neinteractiveliterature/intercode:build-$TRAVIS_COMMIT
    - docker pull neinteractiveliterature/intercode:test-$TRAVIS_COMMIT
    - docker build
      --cache-from neinteractiveliterature/intercode:build-$TRAVIS_COMMIT
      --cache-from neinteractiveliterature/intercode:test-$TRAVIS_COMMIT
      -f Dockerfile.web
      --target production
      -t neinteractiveliterature/intercode:${TRAVIS_COMMIT} .
    - docker push neinteractiveliterature/intercode:${TRAVIS_COMMIT}
    - test/docker-push.sh
notifications:
  slack:
    secure: Ca/xHuvVik0EfevEAmMuLH+Ybd2yj7FuYsSmxJ/4dyxisuKg+tUvnJEZxnrU/QtHOdSyIh3ZAA4gVHd8PALuJ0HYOjotogqCZaQ0ZYTB7pKVvxc8u8YK7aY3P58guib7SrU3iRXsvjaV5xOflaBY4Ng1TQrkc8TCU4i8xZhWxWc=
env:
  global:
  - PATH=$HOME/.local/bin:$PATH
  - CC_TEST_REPORTER_ID=2ec5e525d523a261ed68d45eb18865e8ea7a5b32751290cabde2d44f39e78cce
  - DOCKER_COMPOSE_VERSION=1.23.0
  - secure: FOqb5pEOm+aHRz10TYFnGWPw5q7lY+SPrRWiy3HHvq3UK1vpPzUG2bHI+XPShF/JyCyxdqbyOEgC4DLwLXGebG7wWDolf0yE5iHtUmUuPK68EePulltyG00LM361DkniVhu2cHwXFloH30e3BwSPbgcgQfypZA+ITJ3LGhwZ5+E=
  - secure: PNEoXEJTlUd0fLMJBg2mvusuOqFXH24ZWK3JBwtVt2nW8fco2ePw+ZPe+W5ajs3fHrrfTfY5yB484ZA2f91NvC8bxHHfrZ0sN2CgLepxkn4Ox67NbTIPPBPrAmjBdjF2nwMf3CQ//Yp4g+IXBqA4sPp/spW+b+BIyodqBQMRQ8U=
  - secure: bOZbyApoNrBQVTsrM2hQwuW7VwyIahNFtMrth2uJsq+CRO4zdDrwAba7CJe+us0cSUSKlgLpnPX0F8kgIMtriJkT7GF14CUYHbflRtvrOGzxREISTKhFuyzbfnoB+9pOfyZk4Vu9nXsRpVjWaIa7ySX28jBECQXJrZ1Lspyy2Eg=
  - secure: gITTAZnM8nqHYJDqXS9M0sdoShDr3v7+/tMajvDB2EUgAvtXFKPE/Cv8/nDxhHCTmLU8SUMvFY72HWhDU+tLUoZfUFdnuTtct2do9+VXNUx+p97abdQ1t4qeX6ce2xC83us3VwhvsA1bDnRCb3ErLs37YTFtyZuSKICHQW6yGCY=
  - secure: eDGbrUupdZ9JI1xQdh3hHrRFK+wMa2DE+Dc+MeAVYkQueE5h3JDIl5ituljFCQhSP7Qe/DUyRm1t/0vqWa+AQ4Jg4SghKf8NX7oYze9JIB5D0On40mDZroYo6/AJtAthlEOLc0EzBDl3y7pyjFbxSGFE3bi2MJ48hG0MniU/yVk=
  - secure: UuIzUbDax08gPFnSVD2bB6ma5lSQsPMEgaDgRJEpqMR/5zZ5enSMv1QG5uiW4W6spKqXbM2wRiAxLEfMU1h/MJqNz5trA1+hss8wjHcCcbnTeILv9Qdrn0IUKzsY5JfkqHtQSesLUAmof3AwdP+SZOFZaQ0EQy6BLmulbuP9gfI=
  - secure: l+zizfE9Ve5rOhcXraFA7PEaY6Z5gdlB0lZfL28LFSDOQqKwFA1Gl4FTNusaKbTU8dRLAN+RiRkUMQ+l7E99gBUievqkri7786ZopeStjAG1yQ5yeJe03Knq2Kh8GGhb3K/6WjMPVfOYZtrxVZZZh3LXJ4AnmgjP6g9ptKv6JCM=
  matrix:
  - DATABASE=sqlite LANGUAGE=ruby
  - DATABASE=mysql LANGUAGE=ruby
  - DATABASE=postgresql LANGUAGE=ruby
  - LANGUAGE=javascript
addons:
  code_climate:
    repo_token: 2ec5e525d523a261ed68d45eb18865e8ea7a5b32751290cabde2d44f39e78cce
