ARG RUBY_VERSION=2.5.3

FROM ruby:${RUBY_VERSION}-alpine as build
ARG RAILS_ENV=production

RUN apk add --no-cache build-base yarn git postgresql-dev mariadb-connector-c-dev sqlite-dev cmake flex curl python tzdata

RUN mkdir -p /tmp \
  && cd /tmp \
  && curl -sL https://github.com/graphql/libgraphqlparser/archive/v0.7.0.tar.gz >libgraphqlparser-0.7.0.tar.gz \
  && tar xfz libgraphqlparser-0.7.0.tar.gz \
  && cd /tmp/libgraphqlparser-0.7.0 \
  && cmake . \
  && make install \
  && cd /tmp \
  && rm -rf libgraphqlparser-0.7.0 libgraphqlparser-0.7.0.tar.gz

RUN mkdir -p /usr/src/build \
  && addgroup -S www \
  && adduser -G www -S www \
  && chown www:www /usr/src/build
USER www

WORKDIR /usr/src/build

ENV RAILS_ENV $RAILS_ENV
ENV AWS_ACCESS_KEY_ID dummy
ENV AWS_SECRET_ACCESS_KEY dummy

COPY Gemfile Gemfile.lock /usr/src/build/
RUN bundle install \
  && rm -rf /usr/local/bundle/cache/*.gem \
  && find /usr/local/bundle/gems -name '*.c' -delete \
  && find /usr/local/bundle/gems -name '*.o' -delete

COPY package.json yarn.lock /usr/src/build/
RUN yarn install

COPY --chown=www:www . /usr/src/build

RUN mv config/database.yml.docker config/database.yml \
  && bundle exec rake assets:precompile \
  && rm -rf node_modules tmp/cache

FROM ruby:${RUBY_VERSION}-alpine
ARG RAILS_ENV=production

ENV RAILS_ENV $RAILS_ENV

RUN apk add --no-cache yarn postgresql-libs mariadb-connector-c sqlite tzdata

RUN addgroup -S www \
  && adduser -G www -S www
USER www

COPY --from=build /usr/local/bundle /usr/local/bundle
COPY --from=build /usr/local/lib/libgraphqlparser.so /usr/local/lib/libgraphqlparser.so
COPY --from=build --chown=www /usr/src/build /usr/src/app
WORKDIR /usr/src/app

CMD bundle exec rails server -p $PORT -b 0.0.0.0
