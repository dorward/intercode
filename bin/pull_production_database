#!/usr/bin/env bash

echo 'Getting database URL from Heroku'
PRODUCTION_DATABASE_URL=${PRODUCTION_DATABASE_URL:-$(heroku config:get DATABASE_URL)}

echo 'Pulling database contents'
docker run -i -t --mount type=bind,source="$(pwd)",target=/out postgres:10.4 pg_dump -v -x --no-owner -Fc "$PRODUCTION_DATABASE_URL" -f /out/intercode_production_tmp.pgdump

docker-compose -f docker-compose.dev.yml -f docker-compose.load_production_database.yml -f docker-compose.postgresql.yml run load_production_database

echo 'Erasing production pgdump'
rm intercode_production_tmp.pgdump
